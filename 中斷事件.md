# 9 系統配置控制器 (SYSCFG)
系統配置控制器主要用於重映射程式區域中的記憶體、選擇乙太網路 PHY 介面，並管理外部中斷線與 GPIO 的連接。
此部分適用於整個 STM32F4xx 系列，除非另有指定。

## 9.1 I/O 補償單元
預設情況下，I/O 補償單元不會被使用。然而，當 I/O 輸出緩衝區的速度設定為 50 MHz 或 100 MHz 模式時，建議啟用補償單元，以控制 I/O 上升/下降時間 (tf(IO)out/tr(IO)out) 的切換速率，從而減少 I/O 對電源供應的噪聲。
當補償單元被啟用時，系統會設置 READY 標誌，表示補償單元已準備好並可使用。I/O 補償單元僅能在電源電壓範圍為 2.4 到 3.6 V 時使用。

## 9.2 SYSCFG 暫存器適用於 STM32F405xx/07xx 和 STM32F415xx/17xx 系列
### 略

## 9.3 9.3 SYSCFG 暫存器適用於 STM32F42xxx 和 STM32F43xxx
### 9.3.1 SYSCFG 記憶體重映射暫存器 (SYSCFG_MEMRMP)
### 9.3.2 SYSCFG 外圍模式配置暫存器 (SYSCFG_PMC)
### 9.3.3 SYSCFG 外部中斷配置暫存器 1 (SYSCFG_EXTICR1)
### 9.3.4 SYSCFG 外部中斷配置暫存器 2 (SYSCFG_EXTICR2)
### 9.3.5 SYSCFG 外部中斷配置暫存器 3 (SYSCFG_EXTICR3)
### 9.3.6 SYSCFG 外部中斷配置暫存器 4 (SYSCFG_EXTICR4)
### 9.3.7 補償單元控制暫存器 (SYSCFG_CMPCR)
### 9.3.8 SYSCFG 暫存器映射適用於 STM32F42xxx 和 STM32F43xxx

# 12 中斷與事件
本節適用於整個 STM32F4xx 系列，除非另有說明。
## 12.1 嵌套向量中斷控制器 (NVIC)
### 12.1.1 NVIC 特性
嵌套向量中斷控制器 NVIC 包含以下特性：
- 82 個可遮罩中斷通道：適用於 STM32F405xx/07xx 和 STM32F415xx/17xx，對於 STM32F42xxx 和 STM32F43xxx 可達到 91 個可遮罩中斷通道（不包括 Cortex®-M4 與 FPU 的 16 條中斷線）。
- 16 個可編程優先級層級：使用 4 位元的中斷優先級。
- 低延遲的例外和中斷處理。
- 電源管理控制。
- 系統控制寄存器的實現。
NVIC 與處理器核心介面緊密結合，這使得中斷處理的延遲時間低，並能有效處理延遲到達的中斷。所有中斷（包括核心例外）均由 NVIC 管理。如需有關例外和 NVIC 編程的更多信息，請參閱編程手冊 PM0214。

### 12.1.2 SysTick 校準值寄存器
SysTick 校準值固定為 18750，這在 SysTick 時鐘設置為 18.75 MHz（HCLK/8，HCLK 設置為 150 MHz）時提供了 1 毫秒的參考時間基準。

### 12.1.3 中斷和例外向量
有關 STM32F405xx/07xx、STM32F415xx/17xx 和 STM32F42xxx、STM32F43xxx 設備的向量表，請參見表格 63。

## 12.2 外部中斷/事件控制器 (EXTI)
外部中斷/事件控制器由多達 23 個邊緣檢測器組成，用於生成事件/中斷請求。每個輸入線可以獨立配置，以選擇類型（中斷或事件）和相應的觸發事件（上升沿、下降沿或兩者）。每條線也可以獨立地被遮罩。待處理寄存器維護中斷請求的狀態線。

在以下表格中的灰色行描述了未具體位置的向量。
### (略)表格 62. STM32F405xx/07xx 和 STM32F415xx/17xx 的向量表

### 12.2.1 EXTI 主要特徵
EXTI 控制器的主要特徵包括：

獨立觸發和遮罩：每個中斷/事件線都可以獨立配置觸發方式和遮罩設定。
專用狀態位：每條中斷線都有專用的狀態位，用於表示該線的中斷狀態。
生成軟體事件/中斷請求：最多可生成 23 個軟體事件/中斷請求。
外部信號檢測：能夠檢測脈衝寬度低於 APB2 時鐘週期的外部信號。詳細參數請參考 STM32F4xx 數據手冊的電氣特性部分。

### 12.2.2 EXTI 區塊圖
圖 41. 外部中斷/事件控制器區塊圖
![alt text](./note%20image/外部中斷,事件控制器%20block%20diagram.png)

### 12.2.3 喚醒事件管理
STM32F4xx 能夠處理外部或內部事件，以喚醒核心 (WFE)。喚醒事件可以通過以下方式生成：
- 通過外圍控制寄存器啟用中斷：但不在 NVIC 中啟用，並且在 Cortex®-M4 with FPU 系統控制寄存器中啟用 SEVONPEND 位元。當 MCU 從 WFE 恢復時，必須清除外圍中斷的待處理位元以及 NVIC 中對應的 IRQ 通道待處理位元（在 NVIC 中斷清除待處理寄存器中）。
- 配置外部或內部 EXTI 線為事件模式：當 CPU 從 WFE 恢復時，不需要清除外圍中斷的待處理位元或 NVIC IRQ 通道的待處理位元，因為對應事件線的待處理位元並未設置。

有關如何使用外部線作為喚醒事件，請參閱第 12.2.4 節：功能描述。

### 12.2.4 功能描述
要生成中斷，必須配置並啟用中斷線。這是通過將所需的邊緣檢測編程到兩個觸發寄存器中，並通過將對應位寫入中斷屏蔽寄存器中的‘1’來啟用中斷請求來完成的。當所選邊緣出現在外部中斷線上時，將生成一個中斷請求。與中斷線對應的待處理位也會被設置。這個請求可以通過在待處理寄存器中寫入‘1’來重置。

要生成事件，應配置並啟用事件線。這是通過將所需的邊緣檢測編程到兩個觸發寄存器中，並通過將對應位寫入事件屏蔽寄存器中的‘1’來啟用事件請求來完成的。當所選邊緣出現在事件線上時，將生成一個事件脈衝。與事件線對應的待處理位不會被設置。

中斷/事件請求也可以通過在軟體中斷/事件寄存器中寫入‘1’來生成。

#### 硬體中斷選擇
要將 23 條線配置為中斷來源，請按照以下步驟進行：
- 配置 23 條中斷線的屏蔽位（`EXTI_IMR`）。
- 配置中斷線的觸發選擇位（`EXTI_RTSR` 和 `EXTI_FTSR`）。
- 配置控制映射到外部中斷控制器（`EXTI`）的 NVIC IRQ 通道的使能和屏蔽位，以確保來自 23 條線之一的中斷可以正確地被確認。

#### 硬體事件選擇
要將 23 條線配置為事件來源，請按照以下步驟進行：
- 配置 23 條事件線的屏蔽位（`EXTI_EMR`）。
- 配置事件線的觸發選擇位（`EXTI_RTSR` 和 `EXTI_FTSR`）。

#### 軟體中斷/事件選擇
這 23 條線可以配置為軟體中斷/事件線。以下是生成軟體中斷的步驟：
- 配置 23 條中斷/事件線的屏蔽位（`EXTI_IMR`、`EXTI_EMR`）。
- 在軟體中斷寄存器中設置所需的位（`EXTI_SWIER`）。

### 12.2.5 外部中斷/事件線映射
最多可將 140 個 GPIO（STM32F405xx/07xx 和 STM32F415xx/17xx）和 168 個 GPIO（STM32F42xxx 和 STM32F43xxx）連接到 16 條外部中斷/事件線，如下所示：

#### (略)圖 42. 外部中斷/事件 GPIO 映射 (STM32F405xx/07xx 和 STM32F415xx/17xx)
#### 圖 43. 外部中斷/事件 GPIO 映射 (STM32F42xxx 和 STM32F43xxx)
![alt text](./note%20image/External%20interrupt,event%20GPIO%20mapping.png)
另外七條 EXTI 線的連接方式如下：
- EXTI 線 16 連接到 PVD 輸出
- EXTI 線 17 連接到 RTC 警報事件
- EXTI 線 18 連接到 USB OTG FS 喚醒事件
- EXTI 線 19 連接到以太網喚醒事件
- EXTI 線 20 連接到 USB OTG HS（配置為 FS）喚醒事件
- EXTI 線 21 連接到 RTC 防篡改和時間戳事件
- EXTI 線 22 連接到 RTC 喚醒事件

## 12.3 EXTI 寄存器
參考第 1.1 節：寄存器縮寫列表以獲取寄存器描述中使用的縮寫列表。

### 12.3.1 中斷遮罩寄存器 (EXTI_IMR)
### 12.3.2 事件遮罩寄存器 (EXTI_EMR)
### 12.3.3 上升沿觸發選擇寄存器 (EXTI_RTSR)
### 12.3.4 下降沿觸發選擇寄存器 (EXTI_FTSR)
### 12.3.5 軟體中斷事件寄存器 (EXTI_SWIER)
### 12.3.6 待處理寄存器 (EXTI_PR)
### 12.3.7 EXTI 寄存器映射



